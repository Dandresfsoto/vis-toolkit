<!doctype html>
<meta charset="utf-8">
<script src="../js/d3.js"></script>
<script src="../build/vistk.js"></script>
<link href="../css/vistk.css" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Rajdhani:300|500' rel='stylesheet' type='text/css'>
<style>

body {
    margin: 0;
    height:100%;
    padding: 0;
    color: white;
    font-size: 16px;
    font-family: 'Rajdhani', sans-serif;

    font-weight: 200;
    background-color: #000;
    -webkit-font-smoothing: subpixel-antialiased;
}

input{
    font-size: 14px;
    font-weight: 200;
    font-family: 'Rajdhani', sans-serif;
}

text {
  fill: black;
  stroke: white;
  stroke-width: 1px;

}

rect {
  stroke: white;
  stroke-width: 1px;
  stroke-opacity: 1;
}

</style>
<body>


<div id="notes" style='padding: 20px;'>

  <h1>Import (vertical) vs Exports (horizontal)</h1>

<img src='http://atlas.cid.harvard.edu/media/img/icons/community_106.png' style='width: 20px'>

  <h2>What is the visualization about?</h2>

  <p>World countries roughly export and import products, goods every year. Some countries export more or less than others, </p>

  <h2>Why some countries are not visible?</h2>

</div>

<div id="viz"></div>
<div id="filters"></div>
<script>

d3.json("../../vis-toolkit-datasets/data/countries.json", function(error, countries) {

  d3.json("../../vis-toolkit-datasets/data/countries_exports_categories.json", function(error, exports) {

  //  var countries_enter = d3.select("body").data(countries).enter();

    // TODO
    // -Fixtures for colors of products categories
    // Show colors when enter/hover
    // -Order countries by total exports, imports, and others metadata
    // -Click to select country
    // -Hover to highlight a country (compare with selected)
    // -Re-scale by total
    // -Re-scale to compare with a currently selected country
    // -Show details of the highlighted country on the left
    // --Various numbers we use
    // --Links to The Atlas Ã  la Globe
    // -- Show static images imports, exports, etc..
    // -Title and sub-title catchy and self-explaining
    // -Explanations below to answer most FAQ
    // -Do everything for a specific year

    var categories = [
      {name: 'Animal & Animal Products', pci: 20, opp_gain: 20, color: '#FFE999'},
      {name: 'Vegetable Products', pci: 30, opp_gain: 20, color: '#FFC41C'},
      {name: 'Foodstuffs', pci: 10, opp_gain: 20, color: '#DDFF48'},
      {name: 'Chemicals & Allied Industries', pci: 90, opp_gain: 20, color: '#E377C2'},
      {name: 'Mineral Products', pci: 19, opp_gain: 0, color: '#FFE999'},
      {name: 'Plastics / Rubbers', pci: 13, opp_gain: 30, color: '#F7B6D2'},
      {name: 'Raw Hides, Skins, Leather, & Furs', pci: 10, opp_gain: 20, color: '#98DF8A'},
      {name: 'Textiles', pci: 10, opp_gain: 42, color: '#2CA02C'},
      {name: 'Footwear / Headgear', pci: 20, opp_gain: 20, color: '#3AB11A'},
      {name: 'Wood & Wood Products', pci: 30, opp_gain: 20, color: '#E22020'},
      {name: 'Stone / Glass', pci: 10, opp_gain: 20, color: '#D66011'},
      {name: 'Metals', pci: 10, opp_gain: 20, color: '#5F2107'},
      {name: 'Machinery / Electrical', pci: 10, opp_gain: 20, color: '#65D4DF'},
      {name: 'Transportation', pci: 10, opp_gain: 20, color: '#9EDAE5'},
      {name: 'Miscellaneous', pci: 10, opp_gain: 20, color: '#7F7F7F'},
      {name: 'Service', pci: 10, opp_gain: 20, color: '#C6C6C6'}
    ];

    cat = {
     106: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     116: {'name': 'Vegetable Products', 'color': '#FFC41C'},
     126: {'name': 'Foodstuffs', 'color': '#DDFF48'},
     206: {'name': 'Mineral Products', 'color': '#FFE999'},

     306: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     316: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     406: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     416: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     426: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     506: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
     116: {'name': 'Animal & Animal Products', 'color': '#FFE999'},
    }

    // http://atlas.cid.harvard.edu/media/img/icons/community_106.png
    countries.sort(function(a, b) { return b.sum_all_exports - a.sum_all_exports; });

    countries.forEach(function(d, i) {

      var id = "country_" + d.cca3;

      d3.select("body").append("div").style("float", "left").attr("id", id);

      var data = [];
      d.sum_all_exports = 0;
      d.sum_all_imports = 0;

      exports.forEach(function(e, j) {

        if(e.name3char === d.cca3) {

          var r = {};
          r.value_exports = e.total_exports;
          d.sum_all_exports += e.total_exports;
          r.value_imports = e.total_imports;
          d.sum_all_imports += e.total_imports;
          r.value_diff = e.diff_imports;
          r.community_id = e.community_id;
          r.color = 'white';//cat[e.community_id].color;
          r.year = e.year;

          data.push(r);
         // delete exports[i];
        }

      })

      d.data = data;

      });

      // Remove countries with no data
      countries = countries.filter(function(d) { return d.data.length > 0});

      countries.sort(function(a, b) { return b.sum_all_exports - a.sum_all_exports; });

      countries.forEach(function(country, i) {

        var id = "country_" + country.cca3;

        var visualization = vistk.viz()
          .params({
            type: 'rectmap',
            container: "#" + id,
            height: 80,
            width: 80,
            margin: {top: 10, bottom: 10, left: 10, right: 10},
            data: country.data,
            var_sort: 'value_exports',
            var_group: 'community_id',
            var_color: 'color',
            var_size: 'value_exports',
            var_text: 'community_id',
            var_width: 'value_exports',
            var_height: 'value_imports',
            items: [{
              marks: [{
                type: "rect",
                fill: function(d) { return d['color']; },
                x: 0,
                y: 0,
                width: function(d) { return d.dx; },
                height: function(d) { return d.dy; },
            //    rotate: Math.random()*90 -45
              },{
                type: "text",
                fill: function(d, i) { return i === 0; },
                x: 40,
                y: 55,
                text_anchor: 'end',
                text: function() { return country.cca3; }
              }]
            }],
            time: {
              var_time: 'year',
              current_time: 2013
            },
   //         title: d.cca3
          });

        d3.select("#" + id).call(visualization);


        // Post-styling
        d3.selectAll("rect").style("opacity", .3)

      });

  d3.select("#filters").selectAll('span');

  });

});

</script>

</body>
