<!doctype html>
<meta charset="utf-8">
<script src="../js/d3.js"></script>
<script src="../build/vistk.js"></script>
<link href="../css/vistk.css" rel="stylesheet">
<style>
#legend {
    padding: 1.5em 0 0 1.5em;
}

li.key {
    border-top-width: 15px;
    border-top-style: solid;
    font-size: .75em;
    width: 10%;
    padding-left: 0;
    padding-right: 0;
}

.list-inline>li {
  display: inline-block;
}

.list-inline {
  padding-left: 0;
  list-style: none;
}

ul, ol {
  margin-top: 0;
  margin-bottom: 10px;
}

path.land {
    fill: #eee;
    stroke: #ddd;
}

path.state {
    stroke: #eee;
    stroke-width: 1;
}

.connect__line {
  stroke: #E1DCD6;
  stroke-opacity: .4;
}

.items__mark__star {
  fill: #CBC0B8;
  stroke-width: .5px;
  stroke: red;
  transform: scale(0.5);
}

.items__mark__star.selected {
  stroke-width: 1px;
}

.items__mark__star.highlighted {
  fill: yellow;
  stroke-width: 1.5px;
}

.items__mark__circle {
  fill: #CCC1B9;
}

.items__mark__circle.highlighted {
  fill: #191914;  
  stroke: black;
  stroke-width: 1.5px;
}

.items__mark__circle.selected {
  fill: #EA413D;
}

</style>
<body>
<div id="viz"></div>
<div id="legend"></div>
<script>

//d3.json("../data/atlas_international_product_space.json", function(graph) {

//  d3.json("../data/col_dept_exports_3.json", function(exports) {
/*
    // cog: 0.4208957237122138 coi: 0.8067728413148435 distance: 0.8179699425486985 
    // export_rca: 0.04472251026943858 export_value: 29700 id: 2479 import_value: 3278477
    // product_id: "115" year: 2008  
*/

d3.json("../data/colombia_product_space.json", function(graph) {
  d3.json("../data/colombia_products_location930_2012.json", function(exports) {
    d3.json("../data/colombia_products_metadata.json", function(metadata) {
  /* 
  
    PRODUCT
      "cog": 0.0,
      "coi": 181.64991760253906,
      "department_id": 930,
      "distance": 0.7403764128684998,
      "export_rca": 4.932032108306885,
      "export_value": 13300384,
      "import_value": null,
      "product_id": 420,
      "year": 2012

    METADATA
      "code": "106",
      "description_en": null,
      "description_es": null,
      "id": 0,
      "level": "section",
      "name_en": "Animal & Animal Products",
      "name_es": null,
      "name_short_en": null,
      "name_short_es": null,
      "parent_id": null 
  */

      // Create quasi-dummy categories
      exports.data.forEach(function(d) {

        var m = metadata.data.filter(function(e) {
          return d.product_id == e.id;
        })[0];

        var p = metadata.data.filter(function(e) {
          return m.parent_id == e.id;
        })[0];

        var q = metadata.data.filter(function(e) {
          return p.parent_id == e.id;
        })[0];

        d["group_name_en"] = q["name_en"];

      })

      visualization = vistk.viz()
        .params({
          dev: true,
          type: "productspace",
          container: "#viz",
          width: 800,
          height: 500,
          nodes: graph.nodes,
          links: graph.edges,
          data: exports.data,
          var_x: 'x',
          var_y: 'y',
          var_color: 'coi',
          color: d3.scale.ordinal().domain([0, 0.5, 1]).range(["#DDDDDD", "#AAAAAA", "#777777"]),
          var_group: 'group_name_en',
          var_share: "export_rca",
          share_cutoff: function(d) { return d.export_rca > 1; },
          x_axis_show: false,
          x_grid_show: false,
          y_axis_show: false,
          y_grid_show: false,
          y_invert: true,
          radius: 4,
          var_id: "product_id",
          var_text: 'name_en',
          r_cutoff: function(d) { return d.export_rca < 1; },
          items: [{
            attr: "name",
            marks: [{
              var_mark: '__aggregated',
              type: d3.scale.ordinal().domain([true, false]).range(["text", "none"])
            }, {
              var_mark: '__selected',
              type: d3.scale.ordinal().domain([true, false]).range(["star", "circle"]),
              fill: d3.scale.linear()
                        .domain(d3.extent(exports, function(d) { return d['coi']; }))
                        .range(["#DDDDDD", "#AAAAAA", "#777777"])
              ,
              stroke: function(d) { 
                      return d['export_rca'] > 1 ? "black": "none";
              }
            }, {
              var_mark: '__highlighted',
              type: d3.scale.ordinal().domain([true, false]).range(["text", "none"])
            }]
          }],
          /*
          mark: {
            type: "circle",
            radius: function(d) { var c = d3.scale.linear()
                    .domain(d3.extent(exports, function(d) { return vars.accessor_values(d).export_rca; }))
                    .range([2, 10]);
                    return c(d["export_rca"]);
            },
            fill: function(d) { 
                    var c = d3.scale.linear()
                      .domain(d3.extent(exports, function(d) { return vars.accessor_values(d).export_rca; }))
                      .range(["lightgray", "red"]);
                    return c(d["export_rca"]);
            }
          },
          */
          time: {
            var_time: "year", 
            current_time: "2012",
            parse: function(d) { return d; },
            filter: "2012"
          },
          ui: {
            default: false,
            legend: true
          },
          title: "Product Space Colombia Exports",
          selection: ["115", "116", "117", "118", "119", "120", "121", "122", "123", "124", "125"],
        })
        .set('__aggregated', true)

      d3.select("#viz").call(visualization);


    });

  });

});
</script>
