<!doctype html>
<meta charset="utf-8">
<script src="js/d3.js"></script>
<script src="js/rankings.js"></script>

  <style type="text/css">
  h1 {
    font-family: Tahoma, Arial, Helvetica, sans-serif;
    color: #183061;
    font-size: 23px;
    font-weight: normal;
  }

  table {
    border-collapse: collapse;
  }

  thead {
    font-weight: bold;
  }

  table td, table th, caption {
    padding: 3px;
    border: 1px solid gray;;
  }

  table th:not(:first-child) {
    cursor: s-resize;
  }

  table th:not(:first-child)#sorted {
    cursor: n-resize;
  }

  table td:first-child, table td:last-child {
    text-align: center;
  }

  table tr.odd {
    background-color: #EEE;
  }
  </style>
	
	<p style="clear:both"></p>
	
	<span id="min-time">1995</span> 
	<input type="range" name="points" min="1995" max="2012" step="1" value="0" id="slider-time" oninput="viz.year(this.value); d3.select('#viz').call(viz);" style="width:300px"> 
	<span id="max-time">2012</span>

<div id="communities"></div>

<form action="">
	<input type="radio" name="details" value="low" onclick="set_depth('nesting_0')">Continent
	<input type="radio" name="details" value="mid" onclick="set_depth('nesting_1')">Sub-Continent
	<input type="radio" name="details" value="hi" onclick="set_depth('nesting_2')" checked>Country<br>
</form>

<div id="viz" style="width: 750px; min-height: 520px; height: 520px; overflow: scroll;"></div>


<script>


	/* TODO

		-Generic headers to re-sort regardless the data type
		-Sticky headers
		-Automatic generate time slider (find time boudaries)
		-Auto generate list of filters (find unique classes)
		-Aggregation/nesting (create nesting of data (construct_nest function)
		-Custom filters (e.g. per capita, ..)

		Flags http://atlas.cid.harvard.edu/media/img/icons/flag_ago.png
		Communities http://atlas.cid.harvard.edu/media/img/icons/community_10.png
	
		-What to do with the rank?

	*/

	// Global variables we would find in the Atlas

	item_type = "product";

	// Change the app nesting level
	set_depth = function(arg) {
	  d3.select('#viz').call(viz.depth(arg))    
	}


	var width = 750, height = 500;

  d3.json("data/sapy.json", function(raw) {
  	data = raw;
  	console.log(raw)

  	if(data.app_type == "sapy")
  		item_type = "country"
  	else
  		item_type = "product"


/*
	// Pre-defined one
  if(item_type=="country")
    return ["Rank", "", "Abbrv", "Country", "Complexity", "Share", "Value"]
  else
    return ["Rank", "", "HS4", "Product", "Complexity", "Share", "Value"];
*/


  if(item_type=="country") {


	c = d3.set(
    d3.values(data.attr_data).map(function(d){ return d.continent; })
        .filter(function(d){  return (typeof d !== "undefined") ? d !== null : false })
    ).values();

  } else {

  // Generic way of finding categories
	c = d3.set(
    d3.values(data.attr_data).map(function(d){ return d.community__name; })
        .filter(function(d){  return (typeof d !== "undefined") ? d !== null : false })
    ).values();

				
  }

	d3.select("#communities")
			.data(c)
		.enter()
			.append("label").html(function(d) { return d;})
			.append("input")
			.attr("type", "checkbox")
			.attr("name", function(d) { return d;})
			.attr("value", function(d) { return d;})
			.attr("title", function(d) { return d;})
			.on("click", function(d) {
				
				d3.select("#viz").call(viz.solo(d));
				/*
        d3.select("#viz").call(viz.solo(flat_data.filter(function(dd) { 
          if(dd.nesting_0.name == d.continent)// && dd.year==year) 
            return dd;
        }).map(function(ddd) { 
            return ddd.id 
        })));
*/
			})
			.append("span")


	viz = ranking.viz()
	  .container("#viz")
	  .id_var("id")
	  .height(height)
	  .width(width)
	  .year(1995)
	  .data(data.data)

	if(item_type == "country") {


	 viz.title("Countries Ranking")
	  .columns(["id", "year", "name", "continent"])
    .nesting(["nesting_0","nesting_1","nesting_2"])
    .nesting_aggs({"complexity":"mean","distance":"mean","rca":"mean"})
    .depth("nesting_2");



	} else {


	 viz.title("Products Ranking")
	  .columns(["id", "year", "name", "opp_gain", "pci", "rca", "value"])
    .nesting(["nesting_0","nesting_1","nesting_2"])
    .nesting_aggs({"complexity":"mean","distance":"mean","rca":"mean"})
    .depth("nesting_2");


	}

	d3.select("#viz").call(viz)

});


/*	TODO
	 	.year_var("year")
	 	.csv_data(sample_data)
    .text_var("name")

    .attrs(attr)
    .name_array(["value"])
    .value_var("world_trade")
    .highlight(max_id+"") 
    .tooltip_info(["id","value","complexity","distance","rca","world_trade"])
    .nesting([])
    .total_bar({"prefix": "Export Value: $", "suffix": " USD", "format": ",f"})
    .click_function(inner_html)
    .descs({"id": "This is ID", "val_usd": "This is value USD."})
    .footer("")

	*/

</script>
